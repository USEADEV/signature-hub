<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Replace Signer - SignatureHub</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .replace-form {
      margin-top: 24px;
    }
    .replace-form label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }
    .replace-form input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm, 8px);
      font-size: 0.95rem;
      margin-bottom: 16px;
      box-sizing: border-box;
    }
    .replace-form input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(26, 26, 46, 0.1);
    }
    .info-box {
      background: #f5f5f5;
      padding: 16px;
      border-radius: var(--radius-sm, 8px);
      margin-bottom: 24px;
    }
    .info-box p {
      margin: 4px 0;
      font-size: 0.9rem;
    }
    .info-box .label {
      color: var(--color-text-light);
    }
    .status-declined {
      color: #dc2626;
      font-weight: 600;
    }
    .status-page {
      text-align: center;
      padding: 48px 24px;
    }
    .status-icon {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin: 0 auto 24px;
    }
    .status-icon.success { background: rgba(0, 166, 118, 0.1); color: var(--color-success); }
    .status-icon.error { background: #fee2e2; color: #dc2626; }
    .btn.loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
    }
    .btn.loading::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border: 2px solid transparent;
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      left: 50%;
      top: 50%;
      margin: -9px 0 0 -9px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .inline-error {
      background: rgba(231, 76, 60, 0.08);
      border: 1px solid rgba(231, 76, 60, 0.3);
      color: var(--color-error);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      font-size: 0.9rem;
      display: none;
    }
    .inline-error.visible {
      display: block;
    }

    /* Phone input wrapper */
    .phone-input-wrapper {
      position: relative;
    }
    .phone-input-wrapper input {
      padding-left: 48px !important;
    }
    .phone-flag {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      pointer-events: none;
    }
    .phone-hint {
      font-size: 0.8rem;
      color: var(--color-text-light);
      margin: -12px 0 16px;
    }
    .phone-validation {
      font-size: 0.8rem;
      margin: -12px 0 16px;
      display: none;
    }
    .phone-validation.valid {
      display: block;
      color: var(--color-success);
    }
    .phone-validation.invalid {
      display: block;
      color: var(--color-error);
    }
    .replace-form input.input-valid {
      border-color: var(--color-success);
    }
    .replace-form input.input-invalid {
      border-color: var(--color-error);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-container">
        <img src="/images/usea-logo.svg" alt="SignatureHub" class="logo" onerror="this.style.display='none'">
        <h1>SignatureHub</h1>
      </div>
    </header>

    <main>
      <!-- Loading -->
      <div id="loading" class="section">
        <div class="spinner"></div>
        <p>Loading replacement details...</p>
      </div>

      <!-- Error -->
      <div id="error" class="section hidden status-page">
        <div class="status-icon error">!</div>
        <h2 id="error-title">Something went wrong</h2>
        <p id="error-message">We couldn't load the replacement details.</p>
      </div>

      <!-- Replace Form -->
      <div id="replace-form-section" class="section hidden">
        <h2>Replace Signer</h2>

        <div class="info-box">
          <p><span class="label">Document:</span> <strong id="doc-name"></strong></p>
          <p><span class="label">Previous Signer:</span> <strong id="prev-signer"></strong></p>
          <p><span class="label">Role:</span> <strong id="role-name"></strong></p>
          <p><span class="label">Status:</span> <span id="current-status" class="status-declined"></span></p>
        </div>

        <div id="inline-error" class="inline-error"></div>

        <div class="replace-form">
          <label for="new-name">New Signer's Full Name *</label>
          <input type="text" id="new-name" placeholder="Enter full name" required>

          <label for="new-email">Email Address</label>
          <input type="email" id="new-email" placeholder="Enter email address">

          <label for="new-phone">Phone Number</label>
          <div class="phone-input-wrapper">
            <span class="phone-flag" id="phone-flag"></span>
            <input type="tel" id="new-phone" placeholder="(555) 123-4567" autocomplete="tel">
          </div>
          <p class="phone-hint">US numbers assumed if no country code entered. For international, start with +.</p>
          <p id="phone-validation" class="phone-validation"></p>

          <p style="font-size: 0.85rem; color: var(--color-text-light); margin-bottom: 20px;">
            At least one contact method (email or phone) is required. The new signer will receive a signing invitation.
          </p>

          <button id="btn-submit" class="btn btn-primary">Send to New Signer</button>
        </div>
      </div>

      <!-- Success -->
      <div id="success" class="section hidden status-page">
        <div class="status-icon success">&#10003;</div>
        <h2>Signer Replaced</h2>
        <p>A signing invitation has been sent to <strong id="new-signer-name"></strong>.</p>
        <p style="color: var(--color-text-light); font-size: 0.9rem; margin-top: 8px;">
          You can close this page.
        </p>
      </div>
    </main>

    <footer>
      <p>&copy; 2026 SignatureHub. Secure document signing.</p>
    </footer>
  </div>

  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const roleId = params.get('role');

      const loading = document.getElementById('loading');
      const errorSection = document.getElementById('error');
      const errorTitle = document.getElementById('error-title');
      const errorMessage = document.getElementById('error-message');
      const formSection = document.getElementById('replace-form-section');
      const successSection = document.getElementById('success');
      const inlineError = document.getElementById('inline-error');

      const phoneInput = document.getElementById('new-phone');
      const phoneFlag = document.getElementById('phone-flag');
      const phoneValidation = document.getElementById('phone-validation');

      function showSection(id) {
        [loading, errorSection, formSection, successSection].forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
      }

      function showError(title, message) {
        errorTitle.textContent = title;
        errorMessage.textContent = message;
        showSection('error');
      }

      function showInlineError(msg) {
        inlineError.textContent = msg;
        inlineError.classList.add('visible');
      }

      function hideInlineError() {
        inlineError.classList.remove('visible');
      }

      // --- Phone Formatting ---
      function stripNonDigits(str) {
        return str.replace(/[^\d]/g, '');
      }

      function formatUSPhone(digits) {
        if (digits.length <= 3) return '(' + digits;
        if (digits.length <= 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
        return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6, 10);
      }

      function getPhoneE164() {
        const raw = phoneInput.value.trim();
        if (!raw) return '';
        if (raw.startsWith('+')) {
          return '+' + stripNonDigits(raw);
        }
        const digits = stripNonDigits(raw);
        if (digits.length === 10) return '+1' + digits;
        if (digits.length === 11 && digits.startsWith('1')) return '+' + digits;
        return '+' + digits;
      }

      function validatePhone() {
        const raw = phoneInput.value.trim();
        if (!raw) {
          phoneInput.classList.remove('input-valid', 'input-invalid');
          phoneValidation.className = 'phone-validation';
          phoneFlag.textContent = '';
          return { valid: true, empty: true };
        }

        const isInternational = raw.startsWith('+') && !raw.startsWith('+1');
        const e164 = getPhoneE164();
        const digits = stripNonDigits(e164.slice(1));

        if (isInternational) {
          phoneFlag.textContent = '';
          if (digits.length >= 7 && digits.length <= 15) {
            phoneInput.classList.remove('input-invalid');
            phoneInput.classList.add('input-valid');
            phoneValidation.textContent = 'Valid international number';
            phoneValidation.className = 'phone-validation valid';
            return { valid: true, empty: false };
          } else {
            phoneInput.classList.remove('input-valid');
            phoneInput.classList.add('input-invalid');
            phoneValidation.textContent = 'International numbers should be 7-15 digits';
            phoneValidation.className = 'phone-validation invalid';
            return { valid: false, empty: false };
          }
        }

        // US number
        phoneFlag.textContent = '\uD83C\uDDFA\uD83C\uDDF8';
        const usDigits = stripNonDigits(raw);
        const effectiveDigits = (usDigits.length === 11 && usDigits.startsWith('1')) ? usDigits.slice(1) : usDigits;

        if (effectiveDigits.length === 10) {
          phoneInput.classList.remove('input-invalid');
          phoneInput.classList.add('input-valid');
          phoneValidation.textContent = '+1 ' + formatUSPhone(effectiveDigits);
          phoneValidation.className = 'phone-validation valid';
          return { valid: true, empty: false };
        } else if (effectiveDigits.length < 10) {
          phoneInput.classList.remove('input-valid', 'input-invalid');
          phoneValidation.className = 'phone-validation';
          phoneFlag.textContent = '\uD83C\uDDFA\uD83C\uDDF8';
          return { valid: false, empty: false };
        } else {
          phoneInput.classList.remove('input-valid');
          phoneInput.classList.add('input-invalid');
          phoneValidation.textContent = 'US numbers should be 10 digits';
          phoneValidation.className = 'phone-validation invalid';
          return { valid: false, empty: false };
        }
      }

      phoneInput.addEventListener('input', function() {
        const raw = this.value;
        const isInternational = raw.startsWith('+');

        if (!isInternational) {
          // Auto-format US number as user types
          const digits = stripNonDigits(raw);
          const cursorPos = this.selectionStart;
          const prevLength = raw.length;

          if (digits.length <= 10) {
            const formatted = digits.length > 0 ? formatUSPhone(digits) : '';
            this.value = formatted;
            // Adjust cursor position
            const diff = formatted.length - prevLength;
            this.setSelectionRange(cursorPos + diff, cursorPos + diff);
          }
        }
        validatePhone();
      });

      phoneInput.addEventListener('blur', function() {
        validatePhone();
      });

      // --- End Phone Formatting ---

      if (!token || !roleId) {
        showError('Invalid Link', 'This replacement link is missing required parameters.');
        return;
      }

      // Load replacement info
      fetch(`/sign/${token}/replace-info/${roleId}`)
        .then(res => {
          if (!res.ok) return res.json().then(data => { throw new Error(data.error || 'Failed to load'); });
          return res.json();
        })
        .then(data => {
          document.getElementById('doc-name').textContent = data.documentName;
          document.getElementById('prev-signer').textContent = data.currentSignerName;
          document.getElementById('role-name').textContent = data.roleName;
          document.getElementById('current-status').textContent = data.currentStatus;
          showSection('replace-form-section');
        })
        .catch(err => {
          showError('Unable to Load', err.message || 'Failed to load replacement details.');
        });

      // Submit replacement
      document.getElementById('btn-submit').addEventListener('click', async function() {
        hideInlineError();
        const btn = this;
        const name = document.getElementById('new-name').value.trim();
        const email = document.getElementById('new-email').value.trim();
        const phoneE164 = getPhoneE164();

        if (!name) {
          showInlineError('Please enter the new signer\'s full name.');
          return;
        }
        if (!email && !phoneE164) {
          showInlineError('Please provide at least one contact method (email or phone).');
          return;
        }
        if (phoneE164) {
          const phoneResult = validatePhone();
          if (!phoneResult.valid) {
            showInlineError('Please enter a valid phone number.');
            return;
          }
        }

        btn.classList.add('loading');
        btn.disabled = true;

        try {
          const res = await fetch(`/sign/${token}/replace-signer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roleId, name, email: email || undefined, phone: phoneE164 || undefined }),
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || 'Failed to replace signer');
          }

          document.getElementById('new-signer-name').textContent = name;
          showSection('success');
        } catch (err) {
          showInlineError(err.message || 'An error occurred. Please try again.');
          btn.classList.remove('loading');
          btn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
