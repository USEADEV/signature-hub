<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SignatureHub - API Test Console</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    * { box-sizing: border-box; }
    body { background: #1a1a2e; color: #eee; font-family: 'Segoe UI', system-ui, sans-serif; }
    .test-container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    .header {
      background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #0f3460;
    }
    .header h1 { margin: 0 0 10px 0; color: #e94560; }
    .header p { margin: 0; opacity: 0.8; }

    .api-key-bar {
      background: #16213e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      border: 1px solid #0f3460;
    }
    .api-key-bar label { font-weight: 600; white-space: nowrap; }
    .api-key-bar input {
      flex: 1;
      padding: 10px;
      border: 1px solid #0f3460;
      border-radius: 4px;
      background: #1a1a2e;
      color: #eee;
    }
    .api-key-bar .status {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .status.connected { background: #155724; color: #d4edda; }
    .status.disconnected { background: #721c24; color: #f8d7da; }

    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 20px;
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 6px 6px 0 0;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .tab:hover { background: #0f3460; }
    .tab.active { background: #e94560; border-color: #e94560; color: white; }

    .panel { display: none; }
    .panel.active { display: block; }

    .endpoint-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 1000px) {
      .endpoint-grid { grid-template-columns: 1fr; }
    }

    .endpoint-card {
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 8px;
      padding: 20px;
    }
    .endpoint-card h3 {
      margin: 0 0 5px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .method {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .method.get { background: #28a745; }
    .method.post { background: #007bff; }
    .method.put { background: #ffc107; color: #000; }
    .method.delete { background: #dc3545; }

    .endpoint-path {
      font-family: monospace;
      color: #aaa;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }

    .form-row {
      margin-bottom: 12px;
    }
    .form-row label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #aaa;
    }
    .form-row input, .form-row textarea, .form-row select {
      width: 100%;
      padding: 8px;
      border: 1px solid #0f3460;
      border-radius: 4px;
      background: #1a1a2e;
      color: #eee;
      font-size: 0.9rem;
    }
    .form-row textarea {
      min-height: 80px;
      font-family: monospace;
    }
    .form-row input:focus, .form-row textarea:focus, .form-row select:focus {
      outline: none;
      border-color: #e94560;
    }

    .btn-send {
      background: #e94560;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      margin-top: 10px;
    }
    .btn-send:hover { background: #d63850; }
    .btn-send:disabled { background: #666; cursor: not-allowed; }

    .response-area {
      background: #0d0d1a;
      border: 1px solid #0f3460;
      border-radius: 8px;
      margin-top: 20px;
      overflow: hidden;
    }
    .response-header {
      background: #16213e;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #0f3460;
    }
    .response-status { font-weight: 600; }
    .response-status.success { color: #28a745; }
    .response-status.error { color: #dc3545; }
    .response-body {
      padding: 15px;
      font-family: monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .quick-actions {
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .quick-actions h4 { margin: 0 0 10px 0; color: #e94560; }
    .quick-actions .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn-quick {
      padding: 8px 16px;
      background: #0f3460;
      border: 1px solid #0f3460;
      border-radius: 4px;
      color: #eee;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .btn-quick:hover { background: #1a4a7a; }

    .saved-data {
      background: #0d0d1a;
      border: 1px solid #0f3460;
      border-radius: 4px;
      padding: 10px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 0.8rem;
    }
    .saved-data .label { color: #e94560; }

    .hint { font-size: 0.8rem; color: #888; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="test-container">
    <div class="header">
      <h1>SignatureHub API Test Console</h1>
      <p>Test all API endpoints in your browser. Configure your API key below to get started.</p>
    </div>

    <div class="api-key-bar">
      <label for="globalApiKey">API Key:</label>
      <input type="password" id="globalApiKey" placeholder="Enter your API key">
      <button class="btn-quick" onclick="toggleApiKeyVisibility()">Show</button>
      <button class="btn-quick" onclick="testConnection()">Test Connection</button>
      <span id="connectionStatus" class="status disconnected">Not tested</span>
    </div>

    <div class="quick-actions">
      <h4>Saved Context</h4>
      <div id="savedContext" class="saved-data">
        <span class="label">Last Request ID:</span> <span id="savedRequestId">-</span><br>
        <span class="label">Last Token:</span> <span id="savedToken">-</span><br>
        <span class="label">Last Reference:</span> <span id="savedReference">-</span>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="showPanel('requests')">Signature Requests</div>
      <div class="tab" onclick="showPanel('templates')">Templates</div>
      <div class="tab" onclick="showPanel('signing')">Signing Flow</div>
      <div class="tab" onclick="showPanel('fulltest')">Full Test</div>
    </div>

    <!-- SIGNATURE REQUESTS PANEL -->
    <div id="panel-requests" class="panel active">
      <div class="endpoint-grid">

        <!-- Create Request -->
        <div class="endpoint-card">
          <h3><span class="method post">POST</span> Create Request</h3>
          <div class="endpoint-path">/api/requests</div>

          <div class="form-row">
            <label>Document Name *</label>
            <input type="text" id="cr-documentName" value="Test Agreement">
          </div>
          <div class="form-row">
            <label>Signer Name *</label>
            <input type="text" id="cr-signerName" value="Test User">
          </div>
          <div class="form-row">
            <label>Signer Email</label>
            <input type="email" id="cr-signerEmail" placeholder="test@example.com">
          </div>
          <div class="form-row">
            <label>Signer Phone (E.164 format)</label>
            <input type="tel" id="cr-signerPhone" placeholder="+15551234567">
          </div>
          <div class="form-row">
            <label>Verification Method</label>
            <select id="cr-verificationMethod">
              <option value="email">Email</option>
              <option value="sms">SMS</option>
              <option value="both">Both</option>
            </select>
          </div>
          <div class="form-row">
            <label>Document Content (HTML)</label>
            <textarea id="cr-documentContent"><h3>Test Agreement</h3><p>This is a test document for API testing.</p></textarea>
          </div>
          <div class="form-row">
            <label>Callback URL (optional)</label>
            <input type="url" id="cr-callbackUrl" placeholder="https://your-server.com/webhook">
          </div>
          <div class="form-row">
            <label>External Reference (optional)</label>
            <input type="text" id="cr-externalRef" placeholder="your-system-id-123">
          </div>

          <button class="btn-send" onclick="createRequest()">Create Request</button>
          <div id="response-createRequest" class="response-area" style="display:none;"></div>
        </div>

        <!-- List Requests -->
        <div class="endpoint-card">
          <h3><span class="method get">GET</span> List Requests</h3>
          <div class="endpoint-path">/api/requests</div>

          <div class="form-row">
            <label>Status Filter</label>
            <select id="lr-status">
              <option value="">All</option>
              <option value="pending">Pending</option>
              <option value="viewed">Viewed</option>
              <option value="verified">Verified</option>
              <option value="signed">Signed</option>
              <option value="cancelled">Cancelled</option>
              <option value="expired">Expired</option>
            </select>
          </div>
          <div class="form-row">
            <label>Signer Email</label>
            <input type="text" id="lr-signerEmail" placeholder="Filter by email">
          </div>
          <div class="form-row">
            <label>Limit</label>
            <input type="number" id="lr-limit" value="10">
          </div>

          <button class="btn-send" onclick="listRequests()">List Requests</button>
          <div id="response-listRequests" class="response-area" style="display:none;"></div>
        </div>

        <!-- Get Request by ID -->
        <div class="endpoint-card">
          <h3><span class="method get">GET</span> Get Request by ID</h3>
          <div class="endpoint-path">/api/requests/:id</div>

          <div class="form-row">
            <label>Request ID *</label>
            <input type="text" id="gr-id" placeholder="Enter request ID">
            <button class="btn-quick" style="margin-top:5px;" onclick="document.getElementById('gr-id').value = savedContext.requestId">Use Saved</button>
          </div>

          <button class="btn-send" onclick="getRequest()">Get Request</button>
          <div id="response-getRequest" class="response-area" style="display:none;"></div>
        </div>

        <!-- Get Request by Reference -->
        <div class="endpoint-card">
          <h3><span class="method get">GET</span> Get Request by Reference</h3>
          <div class="endpoint-path">/api/requests/ref/:referenceCode</div>

          <div class="form-row">
            <label>Reference Code *</label>
            <input type="text" id="grr-ref" placeholder="Enter reference code">
            <button class="btn-quick" style="margin-top:5px;" onclick="document.getElementById('grr-ref').value = savedContext.reference">Use Saved</button>
          </div>

          <button class="btn-send" onclick="getRequestByRef()">Get Request</button>
          <div id="response-getRequestByRef" class="response-area" style="display:none;"></div>
        </div>

        <!-- Get Signature -->
        <div class="endpoint-card">
          <h3><span class="method get">GET</span> Get Signature</h3>
          <div class="endpoint-path">/api/requests/:id/signature</div>

          <div class="form-row">
            <label>Request ID *</label>
            <input type="text" id="gs-id" placeholder="Enter request ID">
            <button class="btn-quick" style="margin-top:5px;" onclick="document.getElementById('gs-id').value = savedContext.requestId">Use Saved</button>
          </div>

          <button class="btn-send" onclick="getSignature()">Get Signature</button>
          <div id="response-getSignature" class="response-area" style="display:none;"></div>
        </div>

        <!-- Cancel Request -->
        <div class="endpoint-card">
          <h3><span class="method delete">DELETE</span> Cancel Request</h3>
          <div class="endpoint-path">/api/requests/:id</div>

          <div class="form-row">
            <label>Request ID *</label>
            <input type="text" id="dr-id" placeholder="Enter request ID">
            <button class="btn-quick" style="margin-top:5px;" onclick="document.getElementById('dr-id').value = savedContext.requestId">Use Saved</button>
          </div>

          <button class="btn-send" onclick="cancelRequest()">Cancel Request</button>
          <div id="response-cancelRequest" class="response-area" style="display:none;"></div>
        </div>

      </div>
    </div>

    <!-- TEMPLATES PANEL -->
    <div id="panel-templates" class="panel">
      <div class="endpoint-grid">

        <!-- Create Template -->
        <div class="endpoint-card">
          <h3><span class="method post">POST</span> Create Template</h3>
          <div class="endpoint-path">/api/templates</div>

          <div class="form-row">
            <label>Template Code *</label>
            <input type="text" id="ct-templateCode" placeholder="e.g., LIABILITY_WAIVER_2024">
          </div>
          <div class="form-row">
            <label>Name *</label>
            <input type="text" id="ct-name" placeholder="e.g., Standard Liability Waiver">
          </div>
          <div class="form-row">
            <label>Description</label>
            <input type="text" id="ct-description" placeholder="Template description">
          </div>
          <div class="form-row">
            <label>HTML Content *</label>
            <textarea id="ct-htmlContent"><h2>Liability Waiver</h2><p>I, {{signerName}}, acknowledge and accept all risks.</p></textarea>
          </div>
          <div class="form-row">
            <label>Jurisdiction</label>
            <input type="text" id="ct-jurisdiction" placeholder="e.g., US-VA">
          </div>

          <button class="btn-send" onclick="createTemplate()">Create Template</button>
          <div id="response-createTemplate" class="response-area" style="display:none;"></div>
        </div>

        <!-- List Templates -->
        <div class="endpoint-card">
          <h3><span class="method get">GET</span> List Templates</h3>
          <div class="endpoint-path">/api/templates</div>

          <div class="form-row">
            <label>Jurisdiction Filter</label>
            <input type="text" id="lt-jurisdiction" placeholder="Optional filter">
          </div>

          <button class="btn-send" onclick="listTemplates()">List Templates</button>
          <div id="response-listTemplates" class="response-area" style="display:none;"></div>
        </div>

        <!-- Get Template -->
        <div class="endpoint-card">
          <h3><span class="method get">GET</span> Get Template</h3>
          <div class="endpoint-path">/api/templates/:templateCode</div>

          <div class="form-row">
            <label>Template Code *</label>
            <input type="text" id="gt-templateCode" placeholder="Enter template code">
          </div>

          <button class="btn-send" onclick="getTemplate()">Get Template</button>
          <div id="response-getTemplate" class="response-area" style="display:none;"></div>
        </div>

        <!-- Update Template -->
        <div class="endpoint-card">
          <h3><span class="method put">PUT</span> Update Template</h3>
          <div class="endpoint-path">/api/templates/:templateCode</div>

          <div class="form-row">
            <label>Template Code *</label>
            <input type="text" id="ut-templateCode" placeholder="Enter template code">
          </div>
          <div class="form-row">
            <label>Name</label>
            <input type="text" id="ut-name" placeholder="New name">
          </div>
          <div class="form-row">
            <label>HTML Content</label>
            <textarea id="ut-htmlContent" placeholder="New HTML content"></textarea>
          </div>
          <div class="form-row">
            <label>Active</label>
            <select id="ut-isActive">
              <option value="">No change</option>
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>

          <button class="btn-send" onclick="updateTemplate()">Update Template</button>
          <div id="response-updateTemplate" class="response-area" style="display:none;"></div>
        </div>

        <!-- Delete Template -->
        <div class="endpoint-card">
          <h3><span class="method delete">DELETE</span> Delete Template</h3>
          <div class="endpoint-path">/api/templates/:templateCode</div>

          <div class="form-row">
            <label>Template Code *</label>
            <input type="text" id="dt-templateCode" placeholder="Enter template code">
          </div>

          <button class="btn-send" onclick="deleteTemplate()">Delete Template</button>
          <div id="response-deleteTemplate" class="response-area" style="display:none;"></div>
        </div>

      </div>
    </div>

    <!-- SIGNING FLOW PANEL -->
    <div id="panel-signing" class="panel">
      <div class="endpoint-grid">

        <!-- Get Signing Page Data -->
        <div class="endpoint-card">
          <h3><span class="method get">GET</span> Get Signing Page Data</h3>
          <div class="endpoint-path">/sign/:token/data</div>
          <p class="hint">No API key required - public endpoint</p>

          <div class="form-row">
            <label>Token *</label>
            <input type="text" id="spd-token" placeholder="Enter signing token">
            <button class="btn-quick" style="margin-top:5px;" onclick="document.getElementById('spd-token').value = savedContext.token">Use Saved</button>
          </div>

          <button class="btn-send" onclick="getSigningData()">Get Data</button>
          <div id="response-getSigningData" class="response-area" style="display:none;"></div>
        </div>

        <!-- Send Verification Code -->
        <div class="endpoint-card">
          <h3><span class="method post">POST</span> Send Verification Code</h3>
          <div class="endpoint-path">/sign/:token/verify</div>
          <p class="hint">Sends email or SMS with verification code</p>

          <div class="form-row">
            <label>Token *</label>
            <input type="text" id="sv-token" placeholder="Enter signing token">
            <button class="btn-quick" style="margin-top:5px;" onclick="document.getElementById('sv-token').value = savedContext.token">Use Saved</button>
          </div>
          <div class="form-row">
            <label>Method *</label>
            <select id="sv-method">
              <option value="email">Email</option>
              <option value="sms">SMS</option>
            </select>
          </div>

          <button class="btn-send" onclick="sendVerification()">Send Code</button>
          <div id="response-sendVerification" class="response-area" style="display:none;"></div>
        </div>

        <!-- Confirm Verification Code -->
        <div class="endpoint-card">
          <h3><span class="method post">POST</span> Confirm Verification Code</h3>
          <div class="endpoint-path">/sign/:token/confirm</div>

          <div class="form-row">
            <label>Token *</label>
            <input type="text" id="cv-token" placeholder="Enter signing token">
            <button class="btn-quick" style="margin-top:5px;" onclick="document.getElementById('cv-token').value = savedContext.token">Use Saved</button>
          </div>
          <div class="form-row">
            <label>Verification Code *</label>
            <input type="text" id="cv-code" placeholder="6-digit code" maxlength="6">
          </div>

          <button class="btn-send" onclick="confirmVerification()">Confirm Code</button>
          <div id="response-confirmVerification" class="response-area" style="display:none;"></div>
        </div>

        <!-- Submit Signature -->
        <div class="endpoint-card">
          <h3><span class="method post">POST</span> Submit Signature</h3>
          <div class="endpoint-path">/sign/:token/submit</div>

          <div class="form-row">
            <label>Token *</label>
            <input type="text" id="ss-token" placeholder="Enter signing token">
            <button class="btn-quick" style="margin-top:5px;" onclick="document.getElementById('ss-token').value = savedContext.token">Use Saved</button>
          </div>
          <div class="form-row">
            <label>Signature Type *</label>
            <select id="ss-signatureType">
              <option value="typed">Typed</option>
              <option value="drawn">Drawn</option>
            </select>
          </div>
          <div class="form-row">
            <label>Typed Name (for typed signature)</label>
            <input type="text" id="ss-typedName" placeholder="Full name as signature">
          </div>
          <div class="form-row">
            <label>Consent Text</label>
            <input type="text" id="ss-consentText" value="I agree to sign this document electronically">
          </div>

          <button class="btn-send" onclick="submitSignature()">Submit Signature</button>
          <div id="response-submitSignature" class="response-area" style="display:none;"></div>
        </div>

        <!-- Open Signing Page -->
        <div class="endpoint-card">
          <h3><span class="method get">GET</span> Open Signing Page</h3>
          <div class="endpoint-path">/sign/:token</div>
          <p class="hint">Opens the actual signing page in a new tab</p>

          <div class="form-row">
            <label>Token *</label>
            <input type="text" id="op-token" placeholder="Enter signing token">
            <button class="btn-quick" style="margin-top:5px;" onclick="document.getElementById('op-token').value = savedContext.token">Use Saved</button>
          </div>

          <button class="btn-send" onclick="openSigningPage()">Open Signing Page</button>
        </div>

      </div>
    </div>

    <!-- FULL TEST PANEL -->
    <div id="panel-fulltest" class="panel">
      <div class="endpoint-card" style="max-width: 600px;">
        <h3>Complete End-to-End Test</h3>
        <p>Run a full test of the signature flow: Create request, send verification, confirm code, and submit signature.</p>

        <div class="form-row">
          <label>Your Email (will receive verification code)</label>
          <input type="email" id="ft-email" placeholder="your-real-email@example.com">
        </div>
        <div class="form-row">
          <label>Your Phone (optional, E.164 format)</label>
          <input type="tel" id="ft-phone" placeholder="+15551234567">
        </div>
        <div class="form-row">
          <label>Your Name</label>
          <input type="text" id="ft-name" value="Test Signer">
        </div>
        <div class="form-row">
          <label>Verification Method</label>
          <select id="ft-method">
            <option value="email">Email</option>
            <option value="sms">SMS</option>
          </select>
        </div>

        <button class="btn-send" onclick="runFullTest()" id="ft-btn">Start Full Test</button>

        <div id="ft-log" class="response-area" style="display:none;">
          <div class="response-header">
            <span>Test Progress</span>
          </div>
          <div class="response-body" id="ft-log-body"></div>
        </div>

        <div id="ft-verify" style="display:none; margin-top: 15px;">
          <div class="form-row">
            <label>Enter the verification code you received:</label>
            <input type="text" id="ft-code" placeholder="6-digit code" maxlength="6">
          </div>
          <button class="btn-send" onclick="continueFullTest()">Continue Test</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Saved context for reuse
    const savedContext = {
      requestId: localStorage.getItem('test_requestId') || '',
      token: localStorage.getItem('test_token') || '',
      reference: localStorage.getItem('test_reference') || ''
    };

    function updateSavedContext() {
      document.getElementById('savedRequestId').textContent = savedContext.requestId || '-';
      document.getElementById('savedToken').textContent = savedContext.token || '-';
      document.getElementById('savedReference').textContent = savedContext.reference || '-';
    }
    updateSavedContext();

    function saveContext(key, value) {
      savedContext[key] = value;
      localStorage.setItem('test_' + key, value);
      updateSavedContext();
    }

    function getApiKey() {
      return document.getElementById('globalApiKey').value;
    }

    function toggleApiKeyVisibility() {
      const input = document.getElementById('globalApiKey');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function showPanel(name) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById('panel-' + name).classList.add('active');
      event.target.classList.add('active');
    }

    function showResponse(id, status, data) {
      const el = document.getElementById('response-' + id);
      el.style.display = 'block';
      el.innerHTML = `
        <div class="response-header">
          <span class="response-status ${status >= 200 && status < 300 ? 'success' : 'error'}">
            Status: ${status}
          </span>
        </div>
        <div class="response-body">${JSON.stringify(data, null, 2)}</div>
      `;
    }

    async function apiCall(method, path, body = null, useApiKey = true) {
      const headers = { 'Content-Type': 'application/json' };
      if (useApiKey) {
        headers['X-API-Key'] = getApiKey();
      }

      const options = { method, headers };
      if (body) {
        options.body = JSON.stringify(body);
      }

      const response = await fetch(path, options);
      const data = await response.json();
      return { status: response.status, data };
    }

    async function testConnection() {
      const statusEl = document.getElementById('connectionStatus');
      try {
        const { status } = await apiCall('GET', '/api/requests?limit=1');
        if (status === 200) {
          statusEl.textContent = 'Connected';
          statusEl.className = 'status connected';
        } else if (status === 401 || status === 403) {
          statusEl.textContent = 'Invalid API Key';
          statusEl.className = 'status disconnected';
        } else {
          statusEl.textContent = 'Error: ' + status;
          statusEl.className = 'status disconnected';
        }
      } catch (e) {
        statusEl.textContent = 'Connection Failed';
        statusEl.className = 'status disconnected';
      }
    }

    // === SIGNATURE REQUESTS ===

    async function createRequest() {
      const body = {
        documentName: document.getElementById('cr-documentName').value,
        signerName: document.getElementById('cr-signerName').value,
        signerEmail: document.getElementById('cr-signerEmail').value || undefined,
        signerPhone: document.getElementById('cr-signerPhone').value || undefined,
        verificationMethod: document.getElementById('cr-verificationMethod').value,
        documentContent: document.getElementById('cr-documentContent').value || undefined,
        callbackUrl: document.getElementById('cr-callbackUrl').value || undefined,
        externalRef: document.getElementById('cr-externalRef').value || undefined,
      };

      const { status, data } = await apiCall('POST', '/api/requests', body);
      showResponse('createRequest', status, data);

      if (status === 201 && data.requestId) {
        saveContext('requestId', data.requestId);
        if (data.signUrl) {
          const token = data.signUrl.split('/sign/')[1];
          if (token) saveContext('token', token);
        }
        if (data.referenceCode) {
          saveContext('reference', data.referenceCode);
        }
      }
    }

    async function listRequests() {
      const params = new URLSearchParams();
      const status = document.getElementById('lr-status').value;
      const email = document.getElementById('lr-signerEmail').value;
      const limit = document.getElementById('lr-limit').value;

      if (status) params.append('status', status);
      if (email) params.append('signerEmail', email);
      if (limit) params.append('limit', limit);

      const { status: respStatus, data } = await apiCall('GET', '/api/requests?' + params.toString());
      showResponse('listRequests', respStatus, data);
    }

    async function getRequest() {
      const id = document.getElementById('gr-id').value;
      const { status, data } = await apiCall('GET', '/api/requests/' + id);
      showResponse('getRequest', status, data);
    }

    async function getRequestByRef() {
      const ref = document.getElementById('grr-ref').value;
      const { status, data } = await apiCall('GET', '/api/requests/ref/' + ref);
      showResponse('getRequestByRef', status, data);
    }

    async function getSignature() {
      const id = document.getElementById('gs-id').value;
      const { status, data } = await apiCall('GET', '/api/requests/' + id + '/signature');
      showResponse('getSignature', status, data);
    }

    async function cancelRequest() {
      const id = document.getElementById('dr-id').value;
      const { status, data } = await apiCall('DELETE', '/api/requests/' + id);
      showResponse('cancelRequest', status, data);
    }

    // === TEMPLATES ===

    async function createTemplate() {
      const body = {
        templateCode: document.getElementById('ct-templateCode').value,
        name: document.getElementById('ct-name').value,
        description: document.getElementById('ct-description').value || undefined,
        htmlContent: document.getElementById('ct-htmlContent').value,
        jurisdiction: document.getElementById('ct-jurisdiction').value || undefined,
      };

      const { status, data } = await apiCall('POST', '/api/templates', body);
      showResponse('createTemplate', status, data);
    }

    async function listTemplates() {
      const jurisdiction = document.getElementById('lt-jurisdiction').value;
      const params = jurisdiction ? '?jurisdiction=' + jurisdiction : '';
      const { status, data } = await apiCall('GET', '/api/templates' + params);
      showResponse('listTemplates', status, data);
    }

    async function getTemplate() {
      const code = document.getElementById('gt-templateCode').value;
      const { status, data } = await apiCall('GET', '/api/templates/' + code);
      showResponse('getTemplate', status, data);
    }

    async function updateTemplate() {
      const code = document.getElementById('ut-templateCode').value;
      const body = {};

      const name = document.getElementById('ut-name').value;
      const html = document.getElementById('ut-htmlContent').value;
      const isActive = document.getElementById('ut-isActive').value;

      if (name) body.name = name;
      if (html) body.htmlContent = html;
      if (isActive) body.isActive = isActive === 'true';

      const { status, data } = await apiCall('PUT', '/api/templates/' + code, body);
      showResponse('updateTemplate', status, data);
    }

    async function deleteTemplate() {
      const code = document.getElementById('dt-templateCode').value;
      const { status, data } = await apiCall('DELETE', '/api/templates/' + code);
      showResponse('deleteTemplate', status, data);
    }

    // === SIGNING FLOW ===

    async function getSigningData() {
      const token = document.getElementById('spd-token').value;
      const { status, data } = await apiCall('GET', '/sign/' + token + '/data', null, false);
      showResponse('getSigningData', status, data);
    }

    async function sendVerification() {
      const token = document.getElementById('sv-token').value;
      const method = document.getElementById('sv-method').value;
      const { status, data } = await apiCall('POST', '/sign/' + token + '/verify', { method }, false);
      showResponse('sendVerification', status, data);
    }

    async function confirmVerification() {
      const token = document.getElementById('cv-token').value;
      const code = document.getElementById('cv-code').value;
      const { status, data } = await apiCall('POST', '/sign/' + token + '/confirm', { code }, false);
      showResponse('confirmVerification', status, data);
    }

    async function submitSignature() {
      const token = document.getElementById('ss-token').value;
      const body = {
        signatureType: document.getElementById('ss-signatureType').value,
        typedName: document.getElementById('ss-typedName').value || undefined,
        consentText: document.getElementById('ss-consentText').value,
      };
      const { status, data } = await apiCall('POST', '/sign/' + token + '/submit', body, false);
      showResponse('submitSignature', status, data);
    }

    function openSigningPage() {
      const token = document.getElementById('op-token').value;
      window.open('/sign/' + token, '_blank');
    }

    // === FULL TEST ===

    let fullTestToken = '';

    function ftLog(msg) {
      const el = document.getElementById('ft-log-body');
      el.textContent += new Date().toLocaleTimeString() + ' - ' + msg + '\n';
      el.scrollTop = el.scrollHeight;
    }

    async function runFullTest() {
      const email = document.getElementById('ft-email').value;
      const phone = document.getElementById('ft-phone').value;
      const name = document.getElementById('ft-name').value;
      const method = document.getElementById('ft-method').value;

      if (!email && method === 'email') {
        alert('Email is required for email verification');
        return;
      }
      if (!phone && method === 'sms') {
        alert('Phone is required for SMS verification');
        return;
      }

      document.getElementById('ft-log').style.display = 'block';
      document.getElementById('ft-log-body').textContent = '';
      document.getElementById('ft-btn').disabled = true;

      ftLog('Starting full test...');

      // Step 1: Create request
      ftLog('Step 1: Creating signature request...');
      const createBody = {
        documentName: 'Full Test Document',
        signerName: name,
        signerEmail: email || undefined,
        signerPhone: phone || undefined,
        verificationMethod: method,
        documentContent: '<h2>Test Document</h2><p>This is a full end-to-end test.</p>',
      };

      const { status: createStatus, data: createData } = await apiCall('POST', '/api/requests', createBody);

      if (createStatus !== 201) {
        ftLog('ERROR: Failed to create request - ' + JSON.stringify(createData));
        document.getElementById('ft-btn').disabled = false;
        return;
      }

      ftLog('Request created! ID: ' + createData.requestId);
      fullTestToken = createData.signUrl.split('/sign/')[1];
      ftLog('Token: ' + fullTestToken);
      saveContext('requestId', createData.requestId);
      saveContext('token', fullTestToken);

      // Step 2: Send verification
      ftLog('Step 2: Sending verification code via ' + method + '...');
      const { status: verifyStatus, data: verifyData } = await apiCall('POST', '/sign/' + fullTestToken + '/verify', { method }, false);

      if (verifyStatus !== 200) {
        ftLog('ERROR: Failed to send verification - ' + JSON.stringify(verifyData));
        document.getElementById('ft-btn').disabled = false;
        return;
      }

      ftLog('Verification code sent! ' + verifyData.message);
      ftLog('Waiting for you to enter the code...');

      document.getElementById('ft-verify').style.display = 'block';
    }

    async function continueFullTest() {
      const code = document.getElementById('ft-code').value;

      if (!code || code.length !== 6) {
        alert('Please enter a 6-digit code');
        return;
      }

      // Step 3: Confirm code
      ftLog('Step 3: Confirming verification code...');
      const { status: confirmStatus, data: confirmData } = await apiCall('POST', '/sign/' + fullTestToken + '/confirm', { code }, false);

      if (confirmStatus !== 200) {
        ftLog('ERROR: Failed to confirm code - ' + JSON.stringify(confirmData));
        return;
      }

      ftLog('Code confirmed! Identity verified.');

      // Step 4: Submit signature
      ftLog('Step 4: Submitting signature...');
      const signBody = {
        signatureType: 'typed',
        typedName: document.getElementById('ft-name').value,
        consentText: 'I agree to sign this document electronically',
      };

      const { status: signStatus, data: signData } = await apiCall('POST', '/sign/' + fullTestToken + '/submit', signBody, false);

      if (signStatus !== 200) {
        ftLog('ERROR: Failed to submit signature - ' + JSON.stringify(signData));
        return;
      }

      ftLog('SUCCESS! Document signed at ' + signData.signedAt);
      ftLog('');
      ftLog('=== FULL TEST COMPLETE ===');

      document.getElementById('ft-verify').style.display = 'none';
      document.getElementById('ft-btn').disabled = false;
    }
  </script>
</body>
</html>
