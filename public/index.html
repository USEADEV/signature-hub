<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>USEA eSign - Demo</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .demo-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: center;
      margin: -30px -30px 30px -30px;
      border-radius: 8px 8px 0 0;
    }
    .demo-logo {
      height: 50px;
      margin-bottom: 10px;
    }
    .demo-banner h1 {
      margin: 0 0 5px 0;
      font-size: 1.5rem;
    }
    .demo-banner p {
      margin: 0;
      opacity: 0.9;
    }
    .demo-form {
      max-width: 600px;
      margin: 0 auto;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e4e8;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: #007bff;
    }
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    .result-box {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 6px;
      padding: 20px;
      margin-top: 20px;
    }
    .result-box h3 {
      margin: 0 0 10px 0;
      color: #155724;
    }
    .result-box a {
      color: #007bff;
      word-break: break-all;
    }
    .hint-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
    }
    .hint-box h4 {
      margin: 0 0 10px 0;
      color: #856404;
    }
    .hint-box code {
      background: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
    }
    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .feature {
      text-align: center;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .feature-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .feature h3 {
      margin: 0 0 5px 0;
      font-size: 1rem;
    }
    .feature p {
      margin: 0;
      color: #666;
      font-size: 0.9rem;
    }
    /* Tab styles */
    .tabs {
      display: flex;
      border-bottom: 2px solid #e1e4e8;
      margin-bottom: 30px;
    }
    .tab-btn {
      padding: 15px 25px;
      border: none;
      background: none;
      font-size: 1rem;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab-btn:hover {
      color: #333;
    }
    .tab-btn.active {
      color: #007bff;
      border-bottom-color: #007bff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Signer list styles */
    .signers-list {
      margin-bottom: 20px;
    }
    .signer-item {
      background: #f8f9fa;
      border: 1px solid #e1e4e8;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .signer-item h4 {
      margin: 0 0 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .signer-item .remove-signer {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .signer-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .signer-fields input, .signer-fields select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .add-signer-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    .add-signer-btn:hover {
      background: #218838;
    }
    /* Package result styles */
    .package-result {
      background: #e7f3ff;
      border: 1px solid #b8daff;
      border-radius: 6px;
      padding: 20px;
      margin-top: 20px;
    }
    .package-result h3 {
      margin: 0 0 15px 0;
      color: #004085;
    }
    .signer-urls {
      margin-top: 15px;
    }
    .signer-url-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
    }
    .signer-url-item strong {
      display: block;
      margin-bottom: 5px;
    }
    .signer-url-item .roles-badge {
      display: inline-block;
      background: #6c757d;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-left: 5px;
    }
    .signer-url-item a {
      color: #007bff;
      word-break: break-all;
      font-size: 0.9rem;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <main>
      <div class="demo-banner">
        <img src="/images/usea-logo-white.svg" alt="USEA" class="demo-logo">
        <h1>USEA eSign Demo</h1>
        <p>Document signature application for ShowConnect</p>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="single">Single Signer</button>
        <button class="tab-btn" data-tab="package">Multi-Party Package</button>
      </div>

      <!-- Single Signer Tab -->
      <div id="tab-single" class="tab-content active">
        <div class="demo-form">
          <h2>Create Test Signature Request</h2>
          <p>Fill in the form below to create a signature request and test the signing flow.</p>

          <div class="form-group">
            <label for="documentName">Document Name</label>
            <input type="text" id="documentName" value="Entry Agreement 2024" placeholder="e.g., Entry Agreement 2024">
          </div>

          <div class="form-group">
            <label for="signerName">Signer Name</label>
            <input type="text" id="signerName" value="John Doe" placeholder="e.g., John Doe">
          </div>

          <div class="form-group">
            <label for="signerEmail">Signer Email</label>
            <input type="email" id="signerEmail" value="test@example.com" placeholder="e.g., test@example.com">
          </div>

          <div class="form-group">
            <label for="signerPhone">Signer Phone (for SMS verification)</label>
            <input type="tel" id="signerPhone" placeholder="e.g., +15551234567">
          </div>

          <div class="form-group">
            <label for="verificationMethod">Verification Method</label>
            <select id="verificationMethod">
              <option value="email">Email only</option>
              <option value="sms">SMS only</option>
              <option value="both">Both (Email and SMS)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="apiKey">API Key</label>
            <input type="password" id="apiKey" placeholder="Enter your API key">
          </div>

          <div class="form-group">
            <label for="documentContent">Document Content (HTML)</label>
            <textarea id="documentContent" placeholder="Optional: HTML content to display"><h3>Entry Agreement</h3><p>By signing this document, I agree to the following terms and conditions for participating in the horse show event:</p><ul><li>I understand and accept all risks associated with equestrian activities</li><li>I agree to follow all safety rules and guidelines</li><li>I confirm that all information provided is accurate</li></ul><p>This agreement is binding upon signature.</p></textarea>
          </div>

          <button id="createBtn" class="btn btn-primary" style="width: 100%;">Create Signature Request</button>

          <div id="result" class="result-box hidden">
            <h3>Signature Request Created!</h3>
            <p><strong>Sign URL:</strong></p>
            <p><a id="signUrl" href="#" target="_blank"></a></p>
            <p style="margin-top: 15px;">
              <a id="openSignUrl" href="#" target="_blank" class="btn btn-primary">Open Signing Page</a>
            </p>
          </div>

          <div class="hint-box">
            <h4>Testing Info</h4>
            <p>Enter your API key to test live email/SMS sending. A verification code will be sent to the email or phone number provided.</p>
            <p style="margin-top: 10px;"><strong>Note:</strong> Phone numbers must be in E.164 format (e.g., <code>+15551234567</code>)</p>
          </div>
        </div>
      </div>

      <!-- Multi-Party Package Tab -->
      <div id="tab-package" class="tab-content">
        <div class="demo-form">
          <h2>Create Multi-Party Signing Package</h2>
          <p>Create a package where multiple people can sign the same document with different roles.</p>

          <div class="form-group">
            <label for="pkgDocumentName">Document Name</label>
            <input type="text" id="pkgDocumentName" value="Entry Agreement - Spring Horse Trials 2024" placeholder="e.g., Entry Agreement - Event Name">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="pkgEventDate">Event Date (for age validation)</label>
              <input type="date" id="pkgEventDate" value="2024-03-15">
            </div>
            <div class="form-group">
              <label for="pkgJurisdiction">Jurisdiction (optional)</label>
              <input type="text" id="pkgJurisdiction" placeholder="e.g., US-VA">
            </div>
          </div>

          <div class="form-group">
            <label for="pkgExternalRef">External Reference (optional)</label>
            <input type="text" id="pkgExternalRef" placeholder="e.g., entry-12345">
          </div>

          <div class="form-group">
            <label for="pkgApiKey">API Key</label>
            <input type="password" id="pkgApiKey" placeholder="Enter your API key">
          </div>

          <div class="form-group">
            <label for="pkgDocumentContent">Document Content (HTML with merge variables)</label>
            <textarea id="pkgDocumentContent" placeholder="Use {{variable}} for merge variables"><h3>Entry Agreement - {{eventName}}</h3>
<p><strong>Event Date:</strong> {{eventDate}}</p>
<p><strong>Horse:</strong> {{horseName}}</p>
<p><strong>Rider:</strong> {{riderName}}</p>
<p><strong>Competition Level:</strong> {{competitionLevel}}</p>

<p>By signing this document, I agree to the following terms and conditions for participating in this equestrian event:</p>

<ul>
  <li>I understand and accept all risks associated with equestrian activities</li>
  <li>I agree to follow all safety rules and guidelines established by the organizers</li>
  <li>I confirm that the horse named above is fit to compete</li>
  <li>I confirm that all information provided is accurate and complete</li>
</ul>

<p>This agreement is legally binding upon all signatories.</p></textarea>
          </div>

          <div class="form-group">
            <label for="pkgMergeVariables">Merge Variables (JSON)</label>
            <textarea id="pkgMergeVariables" style="min-height: 80px;">{
  "eventName": "Spring Horse Trials 2024",
  "eventDate": "March 15-17, 2024",
  "horseName": "Big Horse",
  "riderName": "Emily Pile",
  "competitionLevel": "Training Level"
}</textarea>
          </div>

          <h3 style="margin-top: 30px;">Signers</h3>
          <p style="color: #666; margin-bottom: 15px;">Add signers with their roles. Signers with the same email will be consolidated into a single signature request with multiple roles.</p>

          <div id="signersList" class="signers-list">
            <!-- Signer items will be added here -->
          </div>

          <button type="button" id="addSignerBtn" class="add-signer-btn">+ Add Signer</button>

          <button id="createPackageBtn" class="btn btn-primary" style="width: 100%;">Create Signing Package</button>

          <div id="packageResult" class="package-result hidden">
            <h3>Signing Package Created!</h3>
            <p><strong>Package Code:</strong> <span id="pkgCode"></span></p>
            <p><strong>Status:</strong> <span id="pkgStatus"></span></p>
            <div class="signer-urls" id="signerUrls">
              <!-- Signer URLs will be added here -->
            </div>
          </div>

          <div class="hint-box">
            <h4>Multi-Party Signing</h4>
            <p>Signers with the same email address are automatically consolidated - they receive one signature request for all their roles.</p>
            <p style="margin-top: 10px;"><strong>Age Requirements:</strong> Trainer, Coach, and Guardian must be 18+ at the event date. Rider and Owner can be any age.</p>
            <p style="margin-top: 10px;"><strong>Date of Birth:</strong> Required for roles with minimum age requirements (Trainer, Coach, Guardian).</p>
            <p style="margin-top: 10px;"><strong>Merge Variables:</strong> Use <code>{{variableName}}</code> in document content to insert dynamic values.</p>
          </div>
        </div>
      </div>

      <div class="features">
        <div class="feature">
          <div class="feature-icon">&#128274;</div>
          <h3>2FA Verification</h3>
          <p>Email or SMS verification codes</p>
        </div>
        <div class="feature">
          <div class="feature-icon">&#9997;</div>
          <h3>Dual Signing</h3>
          <p>Type or draw your signature</p>
        </div>
        <div class="feature">
          <div class="feature-icon">&#128241;</div>
          <h3>Mobile Ready</h3>
          <p>Works on any device</p>
        </div>
        <div class="feature">
          <div class="feature-icon">&#128203;</div>
          <h3>Audit Trail</h3>
          <p>Full logging and compliance</p>
        </div>
      </div>
    </main>

    <footer>
      <p>&copy; 2026 USEA eSign. Secure document signing for ShowConnect.</p>
      <p class="attribution">Developed and designed by <a href="https://useventing.com" target="_blank">useventing.com</a></p>
    </footer>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
      });
    });

    // Single signer form
    document.getElementById('createBtn').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      btn.textContent = 'Creating...';

      try {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey) {
          alert('Please enter your API key');
          btn.disabled = false;
          btn.textContent = 'Create Signature Request';
          return;
        }

        const verificationMethod = document.getElementById('verificationMethod').value;
        const signerPhone = document.getElementById('signerPhone').value;

        if ((verificationMethod === 'sms' || verificationMethod === 'both') && !signerPhone) {
          alert('Phone number is required for SMS verification');
          btn.disabled = false;
          btn.textContent = 'Create Signature Request';
          return;
        }

        const response = await fetch('/api/requests', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': apiKey
          },
          body: JSON.stringify({
            documentName: document.getElementById('documentName').value,
            signerName: document.getElementById('signerName').value,
            signerEmail: document.getElementById('signerEmail').value,
            signerPhone: signerPhone || undefined,
            documentContent: document.getElementById('documentContent').value,
            verificationMethod: verificationMethod
          })
        });

        const data = await response.json();

        if (response.ok) {
          // Replace backend BASE_URL with actual browser origin
          const signPath = new URL(data.signUrl).pathname;
          const correctUrl = window.location.origin + signPath;

          document.getElementById('signUrl').href = correctUrl;
          document.getElementById('signUrl').textContent = correctUrl;
          document.getElementById('openSignUrl').href = correctUrl;
          document.getElementById('result').classList.remove('hidden');
        } else {
          alert('Error: ' + (data.error || 'Failed to create request'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Signature Request';
      }
    });

    // Package form - Signer management
    let signerCount = 0;

    function addSigner(defaults = {}) {
      signerCount++;
      const signerId = signerCount;
      const signerHtml = `
        <div class="signer-item" data-signer-id="${signerId}">
          <h4>
            <span>Signer #${signerId}</span>
            <button type="button" class="remove-signer" onclick="removeSigner(${signerId})">Remove</button>
          </h4>
          <div class="signer-fields">
            <input type="text" placeholder="Name *" class="signer-name" value="${defaults.name || ''}">
            <select class="signer-role">
              <option value="rider" ${defaults.role === 'rider' ? 'selected' : ''}>Rider</option>
              <option value="owner" ${defaults.role === 'owner' ? 'selected' : ''}>Owner</option>
              <option value="trainer" ${defaults.role === 'trainer' ? 'selected' : ''}>Trainer</option>
              <option value="coach" ${defaults.role === 'coach' ? 'selected' : ''}>Coach</option>
              <option value="guardian" ${defaults.role === 'guardian' ? 'selected' : ''}>Parent/Guardian</option>
              <option value="other" ${defaults.role === 'other' ? 'selected' : ''}>Other</option>
            </select>
            <input type="email" placeholder="Email *" class="signer-email" value="${defaults.email || ''}">
            <input type="date" placeholder="Date of Birth" class="signer-dob" value="${defaults.dateOfBirth || ''}" title="Required for Trainer, Coach, Guardian roles">
          </div>
          <div class="checkbox-group" style="margin-top: 10px;">
            <input type="checkbox" class="signer-minor" id="minor-${signerId}" ${defaults.isMinor ? 'checked' : ''}>
            <label for="minor-${signerId}">Is a minor (under 18)</label>
          </div>
        </div>
      `;
      document.getElementById('signersList').insertAdjacentHTML('beforeend', signerHtml);
    }

    function removeSigner(id) {
      const item = document.querySelector(`.signer-item[data-signer-id="${id}"]`);
      if (item) item.remove();
    }

    function getSigners() {
      const signers = [];
      document.querySelectorAll('.signer-item').forEach(item => {
        const name = item.querySelector('.signer-name').value.trim();
        const email = item.querySelector('.signer-email').value.trim();
        const dateOfBirth = item.querySelector('.signer-dob').value;
        const role = item.querySelector('.signer-role').value;
        const isMinor = item.querySelector('.signer-minor').checked;

        if (name && email) {
          signers.push({
            name,
            email,
            dateOfBirth: dateOfBirth || undefined,
            role,
            isMinor
          });
        }
      });
      return signers;
    }

    // Add default signers
    document.getElementById('addSignerBtn').addEventListener('click', () => addSigner());

    // Add example signers on load
    addSigner({ name: 'Emily Pile', email: 'emily@example.com', role: 'rider', dateOfBirth: '2010-05-15', isMinor: true });
    addSigner({ name: 'Sarah Pile', email: 'sarah@example.com', role: 'guardian', dateOfBirth: '1980-03-22' });
    addSigner({ name: 'John Smith', email: 'john@example.com', role: 'trainer', dateOfBirth: '1985-08-10' });
    addSigner({ name: 'John Smith', email: 'john@example.com', role: 'owner' });

    // Create package
    document.getElementById('createPackageBtn').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      btn.textContent = 'Creating Package...';

      try {
        const apiKey = document.getElementById('pkgApiKey').value;
        if (!apiKey) {
          alert('Please enter your API key');
          btn.disabled = false;
          btn.textContent = 'Create Signing Package';
          return;
        }

        const signers = getSigners();
        if (signers.length === 0) {
          alert('Please add at least one signer with name and email');
          btn.disabled = false;
          btn.textContent = 'Create Signing Package';
          return;
        }

        let mergeVariables = {};
        try {
          const mergeVarsText = document.getElementById('pkgMergeVariables').value.trim();
          if (mergeVarsText) {
            mergeVariables = JSON.parse(mergeVarsText);
          }
        } catch (e) {
          alert('Invalid JSON in merge variables');
          btn.disabled = false;
          btn.textContent = 'Create Signing Package';
          return;
        }

        const response = await fetch('/api/packages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': apiKey
          },
          body: JSON.stringify({
            documentName: document.getElementById('pkgDocumentName').value,
            documentContent: document.getElementById('pkgDocumentContent').value,
            eventDate: document.getElementById('pkgEventDate').value || undefined,
            externalRef: document.getElementById('pkgExternalRef').value || undefined,
            jurisdiction: document.getElementById('pkgJurisdiction').value || undefined,
            mergeVariables: mergeVariables,
            signers: signers
          })
        });

        const data = await response.json();

        if (response.ok) {
          document.getElementById('pkgCode').textContent = data.packageCode;
          document.getElementById('pkgStatus').textContent = data.status;

          // Build signer URLs list
          const urlsContainer = document.getElementById('signerUrls');
          urlsContainer.innerHTML = '<h4 style="margin: 15px 0 10px 0;">Signing URLs:</h4>';

          data.signatureRequests.forEach(req => {
            const signPath = new URL(req.signUrl).pathname;
            const correctUrl = window.location.origin + signPath;
            const rolesText = req.roles.join(', ');

            urlsContainer.innerHTML += `
              <div class="signer-url-item">
                <strong>${req.signerName} <span class="roles-badge">${rolesText}</span></strong>
                <a href="${correctUrl}" target="_blank">${correctUrl}</a>
              </div>
            `;
          });

          document.getElementById('packageResult').classList.remove('hidden');
        } else {
          alert('Error: ' + (data.error || 'Failed to create package'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Signing Package';
      }
    });
  </script>
</body>
</html>
